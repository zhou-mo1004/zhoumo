<script>
    // å…¨å±€å˜é‡
    let points = []; // å­˜å‚¨é¤å…æ•°æ®
    const statusText = document.getElementById('resultArea');
    // å¡«å…¥ä½ çš„é«˜å¾·Key
    const AMAP_KEY = 'e77d3b35665497095c812fab7f3d10d9';

    /**
     * æ ¸å¿ƒä¸»å‡½æ•°
     */
    async function decideWhereToEat() {
        // 1. æ˜¾ç¤ºåŠ è½½ä¸­
        statusText.innerHTML = '<div class="loading-wrapper"><span class="loading"></span> å®šä½ä¸­...</div>';
        
        try {
            // 2. è·å–ç”¨æˆ·ä½ç½®
            const position = await getLocation();
            const { latitude, longitude } = position.coords;
            statusText.innerHTML = '<div class="loading-wrapper"><span class="loading"></span> æœç´¢é™„è¿‘é¤å…...</div>';

            // 3. åŠ è½½é«˜å¾·åœ°å›¾é¤å…æ•°æ®
            await loadNearbyRestaurants(longitude, latitude);

            // 4. éšæœºé€‰æ‹©å¹¶å±•ç¤º
            if (points.length > 0) {
                const randomIndex = Math.floor(Math.random() * points.length);
                showRestaurant(points[randomIndex]);
            } else {
                throw new Error('æœªæ‰¾åˆ°é¤å…æ•°æ®');
            }

        } catch (error) {
            console.error('é”™è¯¯:', error);
            // ä»»ä½•ç¯èŠ‚å¤±è´¥ï¼Œç›´æ¥æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
            statusText.innerHTML = '<p class="status-text" style="color: #ff4400;">è·å–å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®</p >';
            makeFakeRestaurants();
            const randomIndex = Math.floor(Math.random() * points.length);
            showRestaurant(points[randomIndex]);
        }
    }

    /**
     * è·å–ç”¨æˆ·åœ°ç†ä½ç½®
     */
    function getLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå®šä½'));
                return;
            }
            navigator.geolocation.getCurrentPosition(resolve, (err) => {
                reject(new Error('ç”¨æˆ·æ‹’ç»å®šä½æˆ–å®šä½å¤±è´¥'));
            });
        });
    }

    /**
     * åŠ è½½é«˜å¾·åœ°å›¾é™„è¿‘é¤å… (ä»…ä¿ç•™é«˜å¾·ï¼Œå½»åº•åˆ é™¤ç™¾åº¦)
     */
    async function loadNearbyRestaurants(lng, lat) {
        points = []; // æ¸…ç©ºæ—§æ•°æ®
        const url = `https://restapi.amap.com/v3/place/around?key=${AMAP_KEY}&location=${lng},${lat}&radius=3000&types=050000&offset=20&output=JSON`;
        
        const response = await fetch(url);
        const data = await response.json();

        if (data.status === '1' && data.pois && data.pois.length > 0) {
            points = data.pois; // æˆåŠŸè·å–é«˜å¾·æ•°æ®
        } else {
            throw new Error('é«˜å¾·åœ°å›¾è¿”å›ç©ºæ•°æ®æˆ–Keyé”™è¯¯');
        }
    }



    /**
     * å±•ç¤ºé¤å…ä¿¡æ¯
     */
    function showRestaurant(restaurant) {
        const card = `
            <div class="restaurant-card">
                <h3>${restaurant.name || 'æœªçŸ¥é¤å…'}</h3>
                <p>ğŸ“ ${restaurant.address || 'åœ°å€æœªçŸ¥'}</p >
                <p>ğŸ“ ${restaurant.tel || 'ç”µè¯æœªçŸ¥'}</p >
            </div>
        `;
        statusText.innerHTML = card;
    }
</script>
